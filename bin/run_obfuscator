#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset
# set -o xtrace

__root="$(git rev-parse --show-toplevel)"
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

bazel build //src/main/java/com/example/obfuscator:ObfuscatorServer

pushd "${__root}"

AGENT=`find bazel-bin/src/main/java/com/example/obfuscator/ObfuscatorServer.runfiles -name 'opencensus-contrib-agent-*.jar' | head -n1`

${__root}/bazel-bin/src/main/java/com/example/obfuscator/ObfuscatorServer --jvm_flag="-javaagent:${AGENT}"

popd
